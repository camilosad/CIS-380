<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
		<title> Assignment 4 </title>
	</head>
	<body>

		<div data-role="page" id="grocery_mode" data-theme="b">
		  <div data-role="header">
		    <h1>Grocery Mode</h1>
		    <div data-role="navbar">
		      <ul>
		        <li><a href="#" class="ui-btn-active ui-state-persist">Grocery</a></li>
		        <li><a href="#list_mode">Build List</a></li>
		        <li><a href="#shopping_mode">Shopping</a></li>
		      </ul>
		    </div>
		  </div>

		  <div data-role="main" class="ui-content">
		  	<form method="post">
		      <div class="ui-field-contain">
		        <fieldset class="ui-field-contain">
			        <label for="grocery">Grocery:</label>
			        <input type="text" name="grocery" id="grocery_name">
			       	<label for="price">Price:</label>
			        <input type="text" name="price" id="grocery_price">
		        	<label for="category">Category</label>
			        <!-- <input list="grocery_category">
							<datalist id="grocery_category">
							  <option value="">
							</datalist> -->
							<input type="text" name="grocery_category" id="grocery_category">

		      	</fieldset>
		      </div>
		      <input type="submit" data-inline="true" id="submit_grocery" value="Create">
		    </form>
		  </div>

		  <div data-role="footer">
		    <h4>&copy; 2016</h4>
		  </div>
		</div>

		<div data-role="page" id="list_mode" data-theme="b">
    	<div data-role="header">
    		<a href="#show_list" id="button_show_list" data-rel="popup" data-position-to="window" data-transition="fade" class="ui-btn ui-corner-all ui-shadow ui-btn-inline">Show List</a>
      	<h1>List Mode</h1>
      	<button class="ui-btn" id="button_done">Done</button>
      	<div data-role="navbar">
		      <ul>
		        <li><a href="#grocery_mode">Grocery</a></li>
		        <li><a href="#" class="ui-btn-active ui-state-persist">Build List</a></li>
		        <li><a href="#shopping_mode">Shopping</a></li>
		      </ul>
		    </div>
      </div>

      <div data-role="content">
		    <div data-role="popup" id="show_list">
		      <div data-role="header">
		        <h1>List</h1>
		      </div>

		      <div data-role="main" class="ui-content" id="show_list_content">
		        <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		      </div>

		      <div data-role="footer" id="show_list_footer">

		      </div>
		    </div>

      </div>

      <div data-role="footer">
      	<h4>&copy; 2016</h4>
    	</div>
    </div>


        <div data-role="page" id="shopping_mode" data-theme="b">
        	<div data-role="header">
            	<h1>Shopping Mode</h1>
            	<div data-role="navbar">
			      <ul>
			        <li><a href="#grocery_mode">Grocery</a></li>
			        <li><a href="#list_mode">Build List</a></li>
			        <li><a href="#" class="ui-btn-active ui-state-persist">Shopping</a></li>
			      </ul>
			    </div>
	        </div>
	        <div data-role="content">
	        	<div id="div_add_item" style="display:none">
					<h4>New Item</h4>
					<input type="text" id="item_to_add">
					<a href="" id="done">Done</a>
	        	</div>

	        	<div data-role="collapsible">
	        		<h4>List</h4>
		        	<ul data-role="listview" id="list">
		                <li><a href="#">Food</a></li>
		                <li><a href="#">Produce</a></li>
		                <li><a href="#">Supplies</a></li>
	           		</ul>
	           	</div>
	        </div>
	        <div data-role="footer">
	        	<h4>&copy; 2016</h4>
        	</div>
        </div>


	</body>


	<script language = javascript type = "text/javascript">

		// LISTS
		var categories = new Array();
		var lists = new Array();

		// OBJECTS

		function category(name){
			this.name = name;
			this.groceries = new Array();

			this.addToList = function(){
				categories.push(this);
			}

			this.addItem = function(item) {
				this.groceries.push(item);
			}
		}

		function grocery(name, price){
			this.name = name;
			this.price = price;
		}

		function list() {
			this.name = name;
			this.groceries = new Array();

			this.addItem = function(item) {
				this.groceries.push(item);
			}
		}

		// FUNCTIONS

		function save_categories() {
			localStorage.setItem("categories", JSON.stringify(categories));
		}

		function get_categories() {
			return JSON.parse(localStorage.getItem("categories"));
		}

		function clear_grocery_fields() {
			$("#grocery_name").val("");
			$("#grocery_price").val("");
			$("#grocery_category").val("");
		}

		// EVENTS


		$("#submit_grocery").tap(function (e) {
			e.preventDefault();
			var gname = $("#grocery_name").val();
			var gprice = $("#grocery_price").val();
			var g = new grocery(gname, gprice);

			var gcategory = $("#grocery_category").val();
			var category_exists = false;
			$.each(categories, function( index, value ) {
			  if (value.name == gcategory) {
			  	value.addItem(g);
			  	category_exists = true;
			  	return false;
			  }
			});

			if (!category_exists) {
				c = new category(gcategory);
				c.addItem(g);
				categories.push(c);
			}

			save_categories();
			clear_grocery_fields();
		});

		// $("#button_add").tap(function (){
		// 	$("#div_add_item").show();
		// });

		// $("#done").tap(function (){
		// 	$("#div_add_item").hide();
		// });

		// $("#item_to_add").keypress(function (e) {
		// 	var key = e.which;
		// 	if(key == 13){
		// 	    $('ul').first().append($("<li><a href='#'>" + $("#item_to_add").val() + "</a></li>"));
		// 	    $("#item_to_add").val("");
		// 	    $("#list").listview('refresh');
		// 	}
		// });


		$(document).on("pagebeforeshow", "#list_mode", function(){
			var current_list = new list();

			// remove all lists
			var div_content = $("#list_mode").find("div[data-role='content']");
			var all_lists = $(div_content).find("div[data-role='collapsible']");
			$(all_lists).remove();

			// create lists again from the current stored objects
			$.each(categories, function( index, value ) {
				var div_collapsible = $("<div data-role='collapsible'></div>");
			  $(div_collapsible).append($("<h4>" + value.name + "</h4>"));
			  var category_list = $("<ul data-role='listview' id='" + value.name + "_list'></ul>");
			  $.each(value.groceries, function (i, v) {
			  	$(category_list).append($("<li item-price='" + v.price + "' item-name='" + v.name + "'><a href='#'>"+ v.name +"</a></li>"));
			  });

			  $(div_collapsible).append(category_list);
			  div_content.append(div_collapsible);
			});
			$("#list_mode").trigger('create');

			// create tap event to add item to list
			var categories_items = $(div_content).find('li');
			$(categories_items).tap(function () {
				var item_name = $(this).attr('item-name');
				var item_price = $(this).attr('item-price');
				var item = new grocery(item_name, item_price);
				current_list.addItem(item);
				$(this).remove();
			});

			$("#button_show_list").tap(function () {
				// remove the old list, keeping the close button, then adds the new list
				$("#show_list_content").children().slice(1).remove();
				$("#show_list_content").append(create_list_dom(current_list.groceries));
				// remove the old total and adds the new one
				$("#show_list_footer").children().remove();
				$("#show_list_footer").append($("<h1>Total: " + calculate_total(current_list.groceries) + "</h1>"));
			});


		});

		// create list to be shown
		function create_list_dom(list) {
			var ul = $("<ul></ul>");
			$.each(list, function (i, v) {
				$(ul).append($("<li>" + v.name + "</li>"))
			});
			return ul;
		}

		// calculates total price
		function calculate_total(list) {
			var total = 0;
			$.each(list, function (i, v) {
				total += v.price;
			});
			return total;
		}



	</script>
</html>

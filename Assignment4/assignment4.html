<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
		<title> Assignment 4 </title>
	</head>
	<body>

		<div data-role="page" id="grocery_mode">
		  <div data-role="header">
		    <h1>Grocery Mode</h1>
		    <div data-role="navbar">
		      <ul>
		        <li><a href="#" class="ui-btn-active ui-state-persist">Grocery</a></li>
		        <li><a href="#list_mode">Build List</a></li>
		        <li><a href="#shopping_mode">Shopping</a></li>
		      </ul>
		    </div>
		  </div>

		  <div data-role="main" class="ui-content">
		  	<form method="post">
		      <div class="ui-field-contain">
		        <fieldset class="ui-field-contain">
			        <label for="grocery">Grocery:</label>
			        <input type="text" name="grocery" id="grocery_name">
			       	<label for="price">Price:</label>
			        <input type="text" name="price" id="grocery_price">
		        	<label for="category">Category</label>
			        <!-- <input list="grocery_category">
							<datalist id="grocery_category">
							  <option value="">
							</datalist> -->
							<input type="text" name="grocery_category" id="grocery_category">

		      	</fieldset>
		      </div>
		      <input type="submit" data-inline="true" id="submit_grocery" value="Create">
		    </form>
		  </div>

		  <div data-role="footer">
		    <h4>&copy; 2016</h4>
		  </div>
		</div>

		<div data-role="page" id="list_mode">
    	<div data-role="header">
    		<a href="#show_list" id="button_show_list" data-rel="popup" data-position-to="window" data-transition="fade" class="ui-btn ui-corner-all ui-shadow ui-btn-inline">Show List</a>
      	<h1>List Mode</h1>
      	<a href="" id="button_done" class="ui-btn ui-btn-inline ui-corner-all">Done</a>
      	<div data-role="navbar">
		      <ul>
		        <li><a href="#grocery_mode">Grocery</a></li>
		        <li><a href="#" class="ui-btn-active ui-state-persist">Build List</a></li>
		        <li><a href="#shopping_mode">Shopping</a></li>
		      </ul>
		    </div>
      </div>


      <div data-role="content">

      	<div id="div_name_list" style="display:none">
      		<form method="post">
		      	<div class="ui-field-contain">
		        	<fieldset class="ui-field-contain">
								<label for="list_name">List name:</label>
			        	<input type="text" name="list_name" id="list_name">
							</fieldset>
						</div>
						<input type="submit" data-inline="true" id="submit_list" value="Save">
					</form>
      	</div>


		    <div data-role="popup" id="show_list">
		      <div data-role="header">
		        <h1>List</h1>
		      </div>
		      <div data-role="main" class="ui-content" id="show_list_content">
		        <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		      </div>
		      <div data-role="footer" id="show_list_footer">
		      </div>
		    </div>

      </div>

      <div data-role="footer">
      	<h4>&copy; 2016</h4>
    	</div>
    </div>


    <div data-role="page" id="shopping_mode">
    	<div data-role="header" id="shopping_header">
      	<h1>Shopping Mode</h1>
      	<a href="#shopping_popup_done" id="shopping_button_done" class="ui-btn ui-corner-all ui-shadow ui-btn-inline">Done</a>
      	<div data-role="navbar">
		      <ul>
		        <li><a href="#grocery_mode">Grocery</a></li>
		        <li><a href="#list_mode">Build List</a></li>
		        <li><a href="#" class="ui-btn-active ui-state-persist">Shopping</a></li>
		      </ul>
		    </div>
		    <h2 id="shopping_total">Total: </h2>
    	</div>

      <div data-role="content">
				<fieldset class="ui-field-contain" id="fieldset_list">
					<label for="day">Select List</label>
					<select name="list_select" id="list_select" data-native-menu="false">
						<option value=""></option>
					</select>
				</fieldset>

				<ul data-role="listview" data-inset="true" id="shopping_list">
    		</ul>
    	</div>

    	<!-- <div data-role="popup" id="shopping_popup_done">
	      <div data-role="header">
	        <h1 id="popup_shopping_total">Total:</h1>
	      </div>

	      <div data-role="main" class="ui-content" id="popup_missed_items_content">
	        <h2>Items you missed</h2>
	      </div>

	      <div data-role="footer">
	        <a href="#form_for_missed_items_list" data-rel="popup" class="ui-btn ui-btn-inline ui-corner-all">Save as new list</a>

			    <div data-role="popup" id="form_for_missed_items_list" class="ui-content" style="min-width:250px;">
			      <form>
			        <div>
			          <label for="missed_items_list_name" class="ui-hidden-accessible">Name:</label>
			          <input type="text" name="user" id="missed_items_list_name">
			          <input type="submit" data-inline="true" value="Save">
			        </div>
			      </form>
			    </div>
	      </div>

	    </div>
 -->

    	<div data-role="footer">
      	<h4>&copy; 2016</h4>
    	</div>

    </div>

    <div data-role="page" data-dialog="true" id="shopping_popup_done">
		  <div data-role="header">
        <h1 id="popup_shopping_total">Total:</h1>
      </div>

		  <div data-role="main" class="ui-content" id="popup_missed_items_content">
		    <h2>Items you missed</h2>
		  </div>

		  <div data-role="footer">
		    <a href="#form_for_missed_items_list" data-rel="popup" class="ui-btn ui-btn-inline ui-corner-all">Save as new list</a>

			    <div data-role="popup" id="form_for_missed_items_list" class="ui-content" style="min-width:250px;">
			      <form>
			        <div>
			          <label for="missed_items_list_name" class="ui-hidden-accessible">Name:</label>
			          <input type="text" name="user" id="missed_items_list_name" placeholder="List name">
			          <input type="submit" id="button_save_as_new_list" data-inline="true" value="Save">
			        </div>
			      </form>
			    </div>
	      </div>
		  </div>
		</div>

	</body>


	<script language = javascript type = "text/javascript">

		// LISTS
		var categories = new Array();
		var lists = new Array();

		// OBJECTS

		function category(name){
			this.name = name;
			this.groceries = new Array();

			this.addToList = function(){
				categories.push(this);
			}

			this.addItem = function(item) {
				this.groceries.push(item);
			}
		}

		function grocery(name, price){
			this.name = name;
			this.price = price;
		}

		function list() {
			this.name = name;
			this.groceries = new Array();

			this.addItem = function(item) {
				this.groceries.push(item);
			}

			this.removeItem = function(item_name) {
				var index_to_be_removed = -1;

				$.each(this.groceries, function (i, v) {
					if (item_name == v.name) {
						index_to_be_removed = i;
						return false;
					}
				});

				if (index_to_be_removed > -1) {
					this.groceries.splice(index_to_be_removed, 1);
				}
			}

		}

		// FUNCTIONS

		function save_categories() {
			localStorage.setItem("categories", JSON.stringify(categories));
		}

		function get_categories() {
			return JSON.parse(localStorage.getItem("categories"));
		}

		function save_lists() {
			localStorage.setItem("lists", JSON.stringify(lists));
		}

		function get_lists() {
			return JSON.parse(localStorage.getItem("lists"));
		}

		function clear_grocery_fields() {
			$("#grocery_name").val("");
			$("#grocery_price").val("");
			$("#grocery_category").val("");
		}

		function check_price(price){
		  if(price.match(/^-?[0-9]*[.][0-9]+$/)){
				return true;
		  }
		  else{
				return false;
		  }
		}

		// EVENTS

		$("#submit_grocery").tap(function (e) {
			e.preventDefault();
			var gname = $("#grocery_name").val();
			var gprice = $("#grocery_price").val();

			if (check_price(gprice)) {
				var g = new grocery(gname, gprice);

				var gcategory = $("#grocery_category").val();
				var category_exists = false;
				$.each(categories, function( index, value ) {
				  if (value.name == gcategory) {
				  	value.addItem(g);
				  	category_exists = true;
				  	return false;
				  }
				});

				if (!category_exists) {
					c = new category(gcategory);
					c.addItem(g);
					categories.push(c);
				}

				save_categories();
				clear_grocery_fields();
			}
			else{
				alert("Only decimal values are accepted for price! (1.99)");
				$("#grocery_price").val("");
			}
		});

		$("#button_done").tap(function (){
			$("#div_name_list").show();
		});

		// $("#done").tap(function (){
		// 	$("#div_add_item").hide();
		// });

		// $("#item_to_add").keypress(function (e) {
		// 	var key = e.which;
		// 	if(key == 13){
		// 	    $('ul').first().append($("<li><a href='#'>" + $("#item_to_add").val() + "</a></li>"));
		// 	    $("#item_to_add").val("");
		// 	    $("#list").listview('refresh');
		// 	}
		// });

		var current_list = new list();
		$(document).on("pagebeforeshow", "#list_mode", function(){
			// hide div for list name
			$("#div_name_list").hide();

			// remove all lists
			var div_content = $("#list_mode").find("div[data-role='content']");
			var all_lists = $(div_content).find("div[data-role='collapsible']");
			$(all_lists).remove();

			// create lists again from the current stored objects
			$.each(categories, function( index, value ) {
				var div_collapsible = $("<div data-role='collapsible'></div>");
			  $(div_collapsible).append($("<h4>" + value.name + "</h4>"));
			  var category_list = $("<ul data-role='listview' id='" + value.name + "_list'></ul>");
			  $.each(value.groceries, function (i, v) {
			  	$(category_list).append($("<li item-price='" + v.price + "' item-name='" + v.name + "'><a href='#'>"+ v.name +"</a></li>"));
			  });

			  $(div_collapsible).append(category_list);
			  div_content.append(div_collapsible);
			});
			$("#list_mode").trigger('create');

			// create tap event to add item to list
			var categories_items = $(div_content).find("ul[data-role='listview']").find('li');
			$(categories_items).tap(function () {
				var item_name = $(this).attr('item-name');
				var item_price = $(this).attr('item-price');
				var item = new grocery(item_name, item_price);
				current_list.addItem(item);
				$(this).remove();
			});

			$("#button_show_list").tap(function () {
				// remove the old list, keeping the close button, then adds the new list
				$("#show_list_content").children().slice(1).remove();
				$("#show_list_content").append(create_list_dom(current_list.groceries));
				// remove the old total and adds the new one
				$("#show_list_footer").children().remove();
				$("#show_list_footer").append($("<h4>Total: " + calculate_total(current_list.groceries) + "</h4>"));
			});

			$("#submit_list").tap(function (e) {
				e.preventDefault();
				current_list.name = $("#list_name").val();
				lists.push(current_list);
				save_lists();
				$("#list_name").val("");
				$("#div_name_list").hide();
				current_list = new list();
				// $.mobile.navigate("#shopping_mode");
			});

		});

		// create list to be shown
		function create_list_dom(list) {
			var ul = $("<ul></ul>");
			$.each(list, function (i, v) {
				$(ul).append($("<li>" + v.name + "</li>"))
			});
			return ul;
		}

		// calculates total price
		function calculate_total(list) {
			var total = 0;
			$.each(list, function (i, v) {
				total += parseFloat(v.price, 10);
			});
			return total;
		}

		var shopping_list_object = new list();
		var shopping_mode_page_content = $("#shopping_mode").find("div[data-role='content']");
		var shopping_total = 0;

		$(document).on("pagebeforeshow", "#shopping_mode", function(){
			lists = get_lists();
			var fieldset_list = $("#fieldset_list");
			var list_select = $("#list_select");
			list_select.remove();
			list_select = $("<select name='list_select' id='list_select' data-native-menu='false'>");
			list_select.append($("<option value=''></option>"));
			$('#shopping_total').remove();
			$('#shopping_list').remove();

			$.each(lists, function (index, value) {
				if (value.name != "") {
					var list_option = $("<option value='" + value.name + "'>" + value.name + "</option>");
					list_select.append(list_option);
				}
			});

			fieldset_list.append(list_select);
			$("#shopping_mode").trigger('create');

			$('#list_select').on('change', function() {
				var selected_value = this.value;
				shopping_total = 0;
				$.each(lists, function (index, value) {
					if (value.name == selected_value) {
						shopping_list_object.name = value.name;
						shopping_list_object.groceries = value.groceries;
						return false;
					}
				});

				$("#shopping_list").remove();
				var new_shopping_list_ul = $("<ul data-role='listview' data-inset='true' id='shopping_list'></ul>");

				$.each(shopping_list_object.groceries, function (index, value) {
					var li_grocery = $("<li item-price='" + value.price + "' item-name='" + value.name + "' onclick='checkItem(this)'><a href='#'>"+ value.name +"</a></li>");
					new_shopping_list_ul.append(li_grocery);
				});

				shopping_mode_page_content.append(new_shopping_list_ul);
				$("#shopping_mode").trigger('create');
			});

		});

		var shopping_groceries = $(shopping_mode_page_content).find("ul[data-role='listview']").find('li');
		checkItem = function (li){
			var item_name = $(li).attr('item-name');
			var item_price = $(li).attr('item-price');
			shopping_list_object.removeItem(item_name);
			$(li).remove();
			// $(li).addClass('ui-icon-check');

			shopping_total += parseFloat(item_price);
			$('#shopping_total').remove();
			var shopping_header = $('#shopping_header');
			shopping_header.append($("<h1 aria-level='1' role='heading' class='ui-title' id='shopping_total'>Total: $ " + shopping_total + "</h1>"));
		}

		$("#shopping_button_done").tap(function() {
			$("#popup_shopping_total").remove();
			var shopping_popup_header = $('#shopping_popup_done').find("div[data-role='header']");
			shopping_popup_header.append($("<h1 aria-level='1' role='heading' class='ui-title' id='popup_shopping_total'>Total: $ " + shopping_total + "</h1>"));
			$("#popup_missed_items_content").children().slice(1).remove();
			$("#popup_missed_items_content").append(create_list_dom(shopping_list_object.groceries));
			shopping_total = 0;
			lists = get_lists();
		});

		$("#button_save_as_new_list").tap(function (e) {
			// e.preventDefault();
			var missed_items_list_name = $("#missed_items_list_name").val();
			shopping_list_object.name = missed_items_list_name;
			lists.push(shopping_list_object);
			save_lists();
		});



	</script>
</html>
